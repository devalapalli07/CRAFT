{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Assignments</title>
    <link rel="stylesheet" href="{% static 'css/assignment.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
</head>
<body>
    <header>
        <img src="{% static 'images/Logo.jpeg' %}" alt="Student Portal Logo" height="50">
        <nav>
            <ul>
                <li><a href="{% url 'home' %}">Home</a></li>
                <li><a href="{% url 'select_assignments' %}">Assignments</a></li>
                <li><a href="{% url 'last_login' %}">Last Login</a></li>
            </ul>
        </nav>
    </header>
    <h1>Assignments Dashboard</h1>
    <section>
        <h2>Filter Assignments</h2>
<div class="filter-controls">
    <!-- Student Name Dropdown -->
    <label for="student-filter">Student:</label>
    <select id="student-filter" name="student" class="student-select">
        <option value="">All Students</option>
        {% for student in students %}
            <option value="{{ student }}">{{ student }}</option>
        {% endfor %}
    </select>

    <!-- Existing assignment filter -->
    <label for="assignment-filter">Assignment:</label>
    <select id="assignment-filter" name="assignment">
        <option value="">Select Assignment</option>
        {% for assignment in assignments %}
            <option value="{{ assignment.id }}">{{ assignment.title }}</option>
        {% endfor %}
    </select>

    <!-- Status filter -->
    <label for="status-filter">Status:</label>
    <select id="status-filter" name="status">
        <option value="">Select Status</option>
        <option value="on_time">On Time</option>
        <option value="late">Late</option>
        <option value="missing">Missing</option>
        <option value="floating">Floating</option>
    </select>

    <!-- Fixed Score Range filter -->
    <label for="score-filter">Score Range:</label>
    <select id="score-filter" name="score">
        <option value="">Select Score Range</option>
        <option value="<40">Less than 40</option>
        <option value="40-60">40 - 60</option>
        <option value="60-80">60 - 80</option>
        <option value=">80">More than 80</option>
    </select>
</div>

<div id="assignmentTable">
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Assignment</th>
                <th>Status</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody id="submissionsBody">
            <!-- Data will be loaded here dynamically -->
        </tbody>
    </table>
    <div id="loading" style="display: none;">Loading more submissions...</div>
</div>

<script>
$(document).ready(function() {
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let searchTimeout = null;

    // Initialize Select2
    $('#student-filter, #assignment-filter, #status-filter, #score-filter').select2({
        width: '200px'  // Adjust width as needed
    });


    function loadSubmissions(reset = false) {
        if (reset) {
            currentPage = 1;
            hasMore = true;
            $('#submissionsBody').empty();
        }

        if (!hasMore || isLoading) return;

        isLoading = true;
        $('#loading').show();

        const filters = {
            student: $('#student-filter').val(),
            assignment: $('#assignment-filter').val(),
            status: $('#status-filter').val(),
            score: $('#score-filter').val(),
            page: currentPage
        };

        $.ajax({
            url: window.location.href,
            data: filters,
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(response) {
                response.submissions.forEach(sub => {
                    $('#submissionsBody').append(`
                        <tr>
                            <td>${sub.name}</td>
                            <td>${sub.assignment}</td>
                            <td>${sub.status}</td>
                            <td>${sub.score || 'N/A'}</td>
                        </tr>
                    `);
                });
                
                hasMore = response.has_next;
                currentPage++;
                isLoading = false;
                $('#loading').hide();
            }
        });
    }

    // Handle student name filter with debounce
    $('#student-filter').on('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadSubmissions(true);
        }, 500);
    });
    // handler for all filters
    $('#student-filter, #assignment-filter, #status-filter, #score-filter').on('change', function() {
        loadSubmissions(true);
    });

    // Infinite scroll
    $(window).scroll(function() {
        if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
            loadSubmissions();
        }
    });

    // Initial load
    loadSubmissions();
});
</script>
    </section>
</body>
</html>
