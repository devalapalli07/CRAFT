{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Student Portal Home</title>

    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
</head>
<body>
    <header>
        <img src="{% static 'images/Logo.jpeg' %}" alt="Student Portal Logo" height="50">
        <nav>
            <ul>
                <li><a href="{% url 'home' %}">Home</a></li>
                <li><a href="{% url 'last_login' %}">Last login</a></li>
                <li><a href="{% url 'select_assignments' %}">Assignments</a></li>
                <li>
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'logout' %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" style="background:none;border:none;color:white;cursor:pointer;">Logout</button>
                    </form>
                    {% endif %}
                </li>
            </ul>
        </nav>
    </header>

    <h1>Welcome to the CRAFT Student Portal</h1>

    <section>
        <div class="filter-controls">
            <div class="filters-left">
                <label for="section">Section:</label>
                <select id="section" name="section" multiple onchange="updateStudentList()">
                    {% for section in sections %}
                        <option value="{{ section }}">{{ section }}</option>
                    {% endfor %}
                </select>

                <label for="filter-name">Name:</label>
                <input type="text" id="filter-name" oninput="updateStudentList()">

                <label for="filter-email">Email:</label>
                <input type="text" id="filter-email" oninput="updateStudentList()">

                <label for="filter-sis-id">SIS ID:</label>
                <input type="text" id="filter-sis-id" oninput="updateStudentList()">
            </div>

            <div class="filters-right">
                <button id="sendEmailBtn" style="display:none;" onclick="openEmailModal()">Send Email</button>
            </div>
        </div>

        <div id="studentTable">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>SIS ID</th>
                        <th>Section Name</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td><input type="checkbox" class="studentCheckbox" data-name="{{ student.name }}" data-email="{{ student.email }}" data-student-id="{{ student.student_id }}"></td>
                        <td>{{ student.name }}</td>
                        <td>{{ student.email }}</td>
                        <td class="student-id-cell">{{ student.sis_id }}</td>
                        <td class="section-name-cell">{{ student.section_name|slice:"11:" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Email Modal -->
<div id="emailModal" style="display:none; position:fixed; top:20%; left:35%; background:#fff; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h2>Custom Message</h2>
    
    <label for="emailSubject">Subject:</label><br>
    <input type="text" id="emailSubject" placeholder="Enter email subject" style="width: 100%;"><br><br>

    <label for="emailMessage">Message:</label><br>
    <textarea id="emailMessage" rows="8" cols="60">
Hello,

This is a reminder to check your dashboard.

Regards,  
Professor
    </textarea><br><br>

    <button onclick="sendEmails()" class="button-green" id="send-email-btn">Send</button>
        <span id="loading-spinner"></span>
    <button onclick="closeEmailModal()" class="button-red">Cancel</button>
</div>


    <script>
        $(document).ready(function() {
            $('#section').select2({ placeholder: "Select one or more sections", allowClear: true, width: '280px' });

            $('#filter-name, #filter-email, #filter-sis-id').css('width', '240px');

            updateStudentList();

            $(document).on('change', '.studentCheckbox', function() {
                $('#sendEmailBtn').toggle($('.studentCheckbox:checked').length > 0);
            });

            $('#selectAll').on('change', function() {
                $('.studentCheckbox').prop('checked', this.checked);
                $('#sendEmailBtn').toggle(this.checked);
            });
        });

        function updateStudentList() {
            const name = $('#filter-name').val() || '';
            const email = $('#filter-email').val() || '';
            const sisId = $('#filter-sis-id').val() || '';
            const sections = $('#section').val() || '';

            const params = new URLSearchParams({
                name, email, sis_id: sisId, sections: sections.join(',')
            });

            fetch(`/students/filter/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = $('#studentTable tbody');
                    tbody.empty();

                    data.students.forEach(student => {
                        const row = `
                            <tr>
                                <td><input type="checkbox" class="studentCheckbox" data-name="${student.name}" data-email="${student.email}" data-student-id="${student.sis_id}"></td>
                                <td>${student.name}</td>
                                <td>${student.email}</td>
                                <td class="sis-id-cell">${student.sis_id}</td>
                                <td class="section-name-cell">${student.section_name.slice(11)}</td>
                            </tr>`;
                        tbody.append(row);
                    });
                })
                .catch(error => console.error('Error loading students:', error));
        }

        function openEmailModal() {
            $('#emailModal').show();
        }

        function closeEmailModal() {
            $('#emailModal').hide();
        }

        function sendEmails() {
            const sendButton = document.getElementById("send-email-btn");
            const spinner = document.getElementById("loading-spinner");

            sendButton.disabled = true;
            sendButton.classList.add("button-disabled");
            spinner.style.display = "inline-block";

    const selectedStudentIds = $('.studentCheckbox:checked').map(function () {
        // return $(this).closest('tr').find('.sis-id-cell').text().trim();
        return $(this).data('student-id');
    }).get();

    const subject = $('#emailSubject').val();
    const message = $('#emailMessage').val();

    $.ajax({
        url: "{% url 'send_email_home' %}",
        type: "POST",
        contentType: "application/json",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        data: JSON.stringify({
            student_ids: selectedStudentIds,
            subject: subject,
            custom_message: message
        }),
        success: function(response) {
            alert("Emails sent!");
            closeEmailModal();
            sendButton.disabled = false;
            sendButton.classList.remove("button-disabled");
            spinner.style.display = "none";
        },
        error: function(error) {
            alert("Failed to send emails.");
            console.error(error);
            sendButton.disabled = false;
            sendButton.classList.remove("button-disabled");
            spinner.style.display = "none";
        }
    });
}

    </script>
</body>
</html>
