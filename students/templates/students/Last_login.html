{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

    <title>Last Login Activity</title>
    <link rel="stylesheet" href="{% static 'css/last_login.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $("#select-all").click(function() {
                $("input[name='student_ids']").prop('checked', this.checked);
                toggleSendEmailButton();
            });

            $("input[name='student_ids']").change(function() {
                toggleSendEmailButton();
            });

            function toggleSendEmailButton() {
                const anyChecked = $("input[name='student_ids']:checked").length > 0;
                $("#send-email-button").toggle(anyChecked);
            }

            // Initialize Select2 for the inactive_days dropdown
            $('#inactive_days').select2();
			// Now initialize Flatpickr for CALENDAR filter
            flatpickr("#inactive_since", {
                dateFormat: "Y-m-d",
                allowInput: true,
            defaultDate: "{{ inactive_since|default:'' }}"
            });
        });

        function previewMessage() {
            const defaultMessage = `Dear {student_name},\n\nThis is a reminder to log in to your account. You have been inactive on the course CGS 2100 for {inactive_days} days.\n\nRegards,\nProfessor`;
            $("#custom-message").val(defaultMessage);
            $("#message-modal").show();
        }

        function closeModal() {
            $("#message-modal").hide();
        }
function sendEmail() {
    const sendButton = document.getElementById("send-email-btn");
    const spinner = document.getElementById("loading-spinner");

    sendButton.disabled = true;
    sendButton.classList.add("button-disabled");
    spinner.style.display = "inline-block";

    const selectedStudents = $("input[name='student_ids']:checked")
        .map(function() { return this.value; }).get();

    $.ajax({
        url: "{% url 'send_email' %}",
        type: 'POST',
        data: JSON.stringify({
            student_ids: selectedStudents,
            custom_message: $("#custom-message").val()
        }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            alert("Emails sent successfully!");
            closeModal();
            sendButton.disabled = false;
            sendButton.classList.remove("button-disabled");
            spinner.style.display = "none";

        },
        error: function(error) {
            alert("Failed to send emails.");
            console.log(error);
            sendButton.disabled = false;
            sendButton.classList.remove("button-disabled");
            spinner.style.display = "none";

        }
    });
}


    </script>
</head>
<body>
    <header>
        <img src="{% static 'images/Logo.jpeg' %}" alt="Student Portal Logo">
        <nav>
    <ul>
        <li><a href="{% url 'home' %}">Home</a></li>
        <li><a href="{% url 'last_login' %}">Last Login</a></li>
        <li><a href="{% url 'select_assignments' %}">Assignments</a></li>
       <li> 
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'logout' %}" style="display:inline;">
            {% csrf_token %}
                <button type="submit" style="background:none;border:none;color:white;cursor:pointer;">
                    Logout
                </button>
            </form>
        {% endif %}
        </li>
    </ul>
</nav>


    </header>
    <h1>Last Login Activity</h1>
    <section>
        <div class="filter-controls">
            <!-- Adding Calendar based filtering-->
            <form method="get" style="display: inline; margin-right: 1rem;">
                <label for="inactive_since">Inactive Since:</label>
                <input type="date" id="inactive_since" name="inactive_since" value="{{ inactive_since }}">
                <button type="submit">Filter</button>
                {% if inactive_since %}
                        <a href="{% url 'last_login' %}" class="button">Clear</a>
                {% endif %}
            </form>
            <button id="send-email-button" style="display:none;" onclick="previewMessage()">Send Email</button>
        </div>
        {% if enrollments %}
            <p>{{ enrollments|length }} students found.</p>
        {% endif %}
        {% if inactive_since %}
            <p style="margin-top: 1rem;">
            The following students have not logged in since <strong>{{ inactive_since }}</strong> or earlier.
            </p>
        {% endif %}
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Student Name</th>
                    <th>Email</th>
                    <th>Last Activity</th>
                    <th>Inactive Days</th>
                </tr>
            </thead>
            <tbody>
                {% for enrollment in enrollments %}
                <tr>
                    <td><input type="checkbox" name="student_ids" value="{{ enrollment.student_id }}"></td>
                    <td>{{ enrollment.student.name }}</td>
                    <td>{{ enrollment.student.email }}</td>
                    <td>{{ enrollment.last_activity_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ enrollment.inactive_days }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Message Modal -->
        <div id="message-modal" style="display:none;">
            <h2>Custom Message</h2>
            <textarea id="custom-message" rows="10" cols="50"></textarea>
            <button class="button-green" onclick="sendEmail()" id="send-email-btn">Send</button>
            <span id="loading-spinner"></span>
            <button class="button-red" onclick="closeModal()">Cancel</button>
        </div>
    </section>
</body>
</html>